<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="http://www.mapquestapi.com/sdk/leaflet/v1.s/mq-map.js?key=Fmjtd%7Cluurn9uy2g%2Crn%3Do5-9wza00"></script>
<script src="http://www.mapquestapi.com/sdk/leaflet/v1.s/mq-routing.js?key=Fmjtd%7Cluurn9uy2g%2Crn%3Do5-9wza00"></script>
</head>
<body>
 <div>
 <form method="GET" action="hit.html">
 <select id="select-observation" name="observation" onchange="onSelect()"></select>
 <button onclick="onSave(); return false;">Save</button>
 </form>
 </div>
 <div id="map" style="width: 100%; height: 100%"></div>
 <div id="route-narrative"></div>
 <div id="debug"></div>
 <script>
    function onSelect() {
    	window.location.assign('hit.html?observation=' + $('#select-observation').val());
    }
    
    function onSave() {
		var legs = last_legs;
        var points = [];
		if (legs && legs.length) {
            var maneuvers = legs[0].maneuvers;
            for (var i = 0; i < maneuvers.length; ++i) {
	            points.push(maneuvers[i].startPoint);	        	
            }
		}
    	window.alert(JSON.stringify(points));    		
    }
    
 	var observationSet = (function() {
 		var deferred = $.Deferred();
 		
		// parsing the search part (after ?) of this document URL
		var query = (window.location.search || '?').substr(1);
		var map = {};
		query.replace(/([^&=]+)=?([^&]*)(?:&+|$)/g,
				function(match, key, value) {
					(map[key] = map[key] || []).push(decodeURIComponent(value));
				});
		var observation = ('observation' in map) ? map['observation'] : 'ojota-maryland';
		
		$.getJSON('busstop_connections.json').done(function(json) {
			var selectControl = $('#select-observation').empty();
			var found = false;
			json.forEach(function(entry) {
				selectControl.append($('<option>').html(entry.key).val(entry.key));
				if (entry.key == observation) {
					found = true;
					deferred.resolve(entry.key, entry);
				}
			});
			if (!found) {
				deferred.reject(observation);				
			}
			selectControl.ready(function() {
				selectControl.val(observation);
			});
		});
		
		return deferred.promise();
	})();
 	
 	var existingSettingLoaded = (function() {
 		var deferred = $.Deferred();
 		var gist = $.getJSON('https://api.github.com/gists/641946e9286609354373',
 				{ crossDomain: true });
 		gist.done(function(json) {
 			observationSet.done(function(observation, bc) {
 		 		var BusstopIcon = L.Icon.extend({
 		 	    	options: {
 		 	        	iconSize:     [64, 64], // size of the icon
 		 	    		iconAnchor:   [31, 63], // point of the icon which will correspond to marker's location
 		 	        	popupAnchor:  [-3, -60] // point from which the popup should open relative to the iconAnchor
 		 	    	}
 		 		});
 		 		function bc2latLng(latlon_str) {
 		 			var latlons = latlon_str.split(',');
 		 			return L.latLng(parseFloat(latlons[0]), parseFloat(latlons[1]));
 		 		}
 	 	 	 	var originBusstop = {
 	 	 	 	 		//latLng: L.latLng(6.558480343331966, 3.3667516708374023),
 	 	 	 	 		latLng: bc2latLng(bc.from_latlon),
 	 	 	 	 		icon: new BusstopIcon({ iconUrl: 'images/O.png' })
	 	 	 	 	};
 	 	 	 	var destBusstop = {
	 	 	 	 	 	//latLng: L.latLng(6.541618114584303, 3.3675026893615723),
	 	 	 	 	 	latLng: bc2latLng(bc.to_latlon),
	 	 	 	 	 	icon: new BusstopIcon({ iconUrl: 'images/D.png' })
 	 	 	 	 	};

 				if ((observation + ".json") in json.files) {
 	 	 			//deferred.resolve(json.files[observation + ".json"].raw_url, busstop_connection);
 	 	 			var url = json.files[observation + ".json"].raw_url;
 	 	 	 	 	$.getJSON(url, function(json) {
 	 	 	 	 		var a = L.latLng(json.fromNode.geometry.coordinates[1], json.fromNode.geometry.coordinates[0]);
 	 	 	 	 		var b = L.latLng(json.toNode.geometry.coordinates[1], json.toNode.geometry.coordinates[0]);
						deferred.resolve(originBusstop, destBusstop, a, b);
 	 	 	 	 	});
 				} else {
 					deferred.resolve(originBusstop, destBusstop, originBusstop.latLng, destBusstop.latLng);
 				}
 			});
 		});
 	 	return deferred.promise();
 	})();
 	
 	var baseMaps = {
			"MapBox": L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
				id: 'examples.map-i875mjb7'
			}),
			"MapQuest": MQ.mapLayer(),
			"OSM": L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
			})
		};
		
	var roadMap = L.layerGroup([]);
	
	$.getJSON("lagos_nigeria-roads.geojson").done(function(gj) {
		//var gj = {
		//		type: "LineString",
		//		coordinates: [[3.3667516708374023, 6.558480343331966], [3.3675026893615723, 6.541618114584303] ]
		//};
		var roads = L.geoJson(gj, {
		    filter: function (feature, layer) {
		    	var highway = feature.properties.type;
		    	if (!highway || highway == "service" || highway == "residential"
		    		|| highway == "rail" || highway == "footway" || highway == "track" || highway == "pier" || highway == "steps" || highway == "living_street") {
		    		return false;
		    	} else if (highway == "unclassified" || highway == "road" 
		    			|| highway == "motorway" || highway == "trunk" || highway == "primary" || highway == "secondary"  || highway == "tertiary"
		    		|| highway == "motorway_link" || highway == "trunk_link" || highway == "primary_link" || highway == "secondary_link"  || highway == "tertiary_link") {
		    		return true;
		    	}
		        return false;
		    },
		    style: function (feature) {
		        return { color: 'yellow' };
		    },
		    onEachFeature: function (feature, layer) {
		    	if (feature.properties.name) {
		    		layer.bindPopup(feature.properties.name + "\n(" + feature.properties.osm_id + ")" );
		    	} else {
		    		layer.bindPopup(feature.properties.osm_id);
		    	}
		    }
		});
		roadMap.addLayer(roads);
	});
	
	// no way to know when rerouting happens
	var last_legs = null;
	
	function createBusstopLink(originBusstop, destBusstop, a, b) {		
		var dir = MQ.routing.directions().on('success', function(data) {
			var legs = data.route.legs;
	        var html = '';

			if (legs && legs.length) {
				last_legs = legs;
				
				L.DomUtil.get('debug').innerHTML = JSON.stringify(data.route);
				
	            var maneuvers = legs[0].maneuvers;
	            var url = "https://mich.cloudant.com/osm/_design/segments/_geo/by_geometry?radius=5&relation=%22dwithin%22&include_docs=true";
	            url += '&callback=?'
	            url += '&lon=' + maneuvers[0].startPoint.lng;
	            url += '&lat=' + maneuvers[0].startPoint.lat;
	            $.getJSON(url, { crossDomain: true }).done(function(json) {
	            	//L.DomUtil.get('debug').innerHTML = JSON.stringify(legs) + "\n" + JSON.stringify(json);
	            }).fail(function(json) {
	            	window.alert(JSON.stringify(json));
	            });
	            maneuvers[0].startPoint.lat
	            for (var i = 0; i < maneuvers.length; ++i) {
		            var startPoint = maneuvers[i].startPoint;	        	
	                html += (i + 1) + '. ';
	                html += '(' + startPoint.lat + ', ' + startPoint.lng + ') ';
	                html += maneuvers[i].narrative + '<br />';
	            }
	            L.DomUtil.get('route-narrative').innerHTML = html;
			}
	  	});
		dir.route({
			locations: [
		    	{ latLng: a },
		    	{ latLng: b } ],
		    options: { doReverseGeocode: false, maxLinkId: 20 }
		});
				
		return L.layerGroup([
			L.marker(originBusstop.latLng, { icon: originBusstop.icon })
		    	.bindPopup("From: <b>Anthony Isale</b> Anthony, Lagos<br />along Ikorodu road").openPopup(),
		    L.marker(destBusstop.latLng, { icon: destBusstop.icon })
		    	.bindPopup("To: <b>Palm Groove</b> Surulere, Lagos<br />"),
		    MQ.routing.routeLayer({ directions: dir })
		]);
	}
	
	existingSettingLoaded.done(function(originBusstop, destBusstop, a, b) {
 		// anthonyisale-palmgroove
 		// anthonyisale 6.558480343331966, 3.3667516708374023
 		// palmgroove 6.541618114584303, 3.3675026893615723
 		var overlayMaps = {
 			"anthonyisale-palmgroove" : createBusstopLink(originBusstop, destBusstop, a, b)
 		};
 		
 		var map = L.map('map', {
 			layers: [ baseMaps["OSM"], roadMap, overlayMaps["anthonyisale-palmgroove"] ]
 		}).fitBounds(L.latLngBounds([ originBusstop.latLng, destBusstop.latLng ]).pad(0.1));
 		
 		L.control.layers(baseMaps, overlayMaps).addTo(map);
 	});
 </script>
</body>
</html>
